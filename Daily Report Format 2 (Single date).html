<html>
<head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>

    <script type="text/javascript" async>

        var startDate;
        var endDate;
        var sd, sd1, ed, ed1;

        var url = window.location.href;
        var ou = url.split('=')[2];
        var org, CurrentOrg,orgLevel4, orgLevel5, orgLevel6;
        var orgLevel4Name, orgLevel5Name, orgLevel6Name;
        var code, HabitationName;

        $.ajaxSetup({
            cache: false,
            async : false,
        });
        $(document).ready(function() {
            var date = new Date();
            if( (date.getMonth()+1) <10){
                month="0"+(date.getMonth()+1)
            }
            var now = date.getFullYear()+'-' + month + '-'+date.getDate();
            document.getElementById('start').value = now;

        });
        function submit()
        {

            var diagnosis=[];
            var index=1;
            startDate = document.getElementById("start").value;
            sd1 = startDate.split('-');
            sd = sd1.join('');

            $('.reporttable tbody').remove();
            $('.reporttable tbody').detach();


            $('#loader').show("start",function(){
                $.getJSON("../api/analytics/events/query/xqoEn6Je5Kj.json?stage=jo25vJdB3qx&dimension=pe:"+sd+"&dimension=ou:"+ou+"&dimension=PGI15ncAV5k&dimension=z9Colwp3mn9&dimension=XgdH09VShof&dimension=sRXValuzUn9&dimension=ZlTELnzAVjO&dimension=HApLmpiq7JM&dimension=hDZmCzzNLPt&dimension=IGbdOw0ahp8&dimension=Vq9dbdqC0P1&dimension=T1rKr8RpGqT&dimension=UAK18oIEFhR&dimension=pk2wLvHgWmL&dimension=SBSdkkr5YA2&dimension=DYm1XDH3HRH&dimension=sbe1ICqbSLB&dimension=lgyX39VDCgj&dimension=s7oVZLOOIky&displayProperty=NAME" , function(data){

                    document.getElementById("sd").innerHTML = startDate;
                    document.getElementById("ed").innerHTML = endDate;

                    for(var i=0;i<data.height;i++){

                        var Doc = data.rows[i][2].split(" ");
                        org = data.rows[i][7];
                        code = data.rows[i][12];
                        var k = 0;

                        for(var j=15; j<data.rows[i].length;j++){
                            if(data.rows[i][j] == "positive"){diagnosis[k] =	data.headers[j].column;
                                k++;}
                        }
                        if(diagnosis.length==0){diagnosis[0]="none";}
                        getOrg(org,code);
                        getHabitationName(code);
                        var Rage = data.rows[i][9];
                        var age = Math.round(Rage);
                        var Contact = data.rows[i][14];
                        if(Contact != '0.0'){
                            var ContactN = (Contact + '').replace('.','') ;
                            var ContactNumber = ContactN.substring(0, 10);
                        }
                        else{ContactNumber = ''}
                        var row = $("<tbody><tr><td  id = 'tablerowsh' colspan='1' id='td'>"+index+"<td id = 'tablerowsh' colspan='1' id='td'>"+Doc[0]+"</td><td  id = 'tablerowsh' colspan='1' id='td'>"+data.rows[i][8]+"</td><td id = 'tablerowsh' colspan='1' id='td'>"+ age +"</td><td  id = 'tablerowsh' colspan='1' id='td'>"+data.rows[i][10]+"</td><td id = 'tablerowsh' colspan='1' id='td'>"+data.rows[i][11]+"</td><td  id = 'tablerowsh' colspan='1' id='td'>"+HabitationName+"</td><td id = 'tablerowsh' colspan='1' id='td'>"+orgLevel5Name+"</td><td  id = 'tablerowsh' colspan='1' id='td'>"+orgLevel4Name+"</td><td id = 'tablerowsh' colspan='1' id='td'>"+data.rows[i][13]+"</td><td  id = 'tablerowsh' colspan='1' id='td'>"+ContactNumber+"</td><td id = 'tablerowsh' colspan='1' id='td'>"+diagnosis+"</td><td  id = 'tablerowsh' colspan='1' id='td'>"+orgLevel6Name+"</td><td id = 'tablerowsh' colspan='1' id='td'>None</td></tr></tbody>" );
                        $(".reporttable").append(row);
                        index++;
                    }
                });
                $('#loader').hide();
            });
        }
    </script>
    <script type="text/javascript" async>
        function getOrg(CurrentOrg,code){
            $.getJSON("../api/organisationUnits.json?&filter=code:eq:"+code+"&fields=ancestors,parent&paging=false",function(data2){
                orgLevel4 = data2.organisationUnits[0].ancestors[3].id;

                $.getJSON("../api/25/organisationUnits/"+orgLevel4+".json?paging=false",function(data3){
                    orgLevel4Name = data3.displayName;
                });

                orgLevel5 = data2.organisationUnits[0].ancestors[4].id;

                $.getJSON("../api/25/organisationUnits/"+orgLevel5+".json?paging=false",function(data4){
                    orgLevel5Name = data4.displayName;
                });

                orgLevel6 = data2.organisationUnits[0].ancestors[5].id;

                $.getJSON("../api/25/organisationUnits/"+orgLevel6+".json?paging=false",function(data5){
                    orgLevel6Name = data5.displayName;
                });
            });
            return (orgLevel4Name,orgLevel5Name,orgLevel6Name);
        }

    </script>
    <script type = "text/javascript" async>

        function getHabitationName(code){
            $.getJSON("../api/optionSets/Y0PP4hMNAcX.json?fields=options[id,name,code]&paging=false",function(data){
                for(var j=0;j<data.options.length;j++){
                    if(data.options[j].code == code){
                        HabitationName = data.options[j].name;
                    }
                }
            });
            return HabitationName;
        }

    </script>
    <script type="text/javascript">

        function exportExcel() {
            var a = document.createElement('a');
            var data_type = 'data:application/vnd.ms-excel';
            var table_div = document.getElementsByClassName('reporttable')[0];
            var table_html = table_div.outerHTML.replace(/ /g, '%20');
            a.href = data_type + ', ' + table_html;
            a.download = 'Daily Report.xls';
            a.click();
            e.preventDefault();
        }

    </script>
    <style type="text/css">
        #tablerowsh
        {
            border: 1px solid black;
        }
        th , #tablerows , tr{
            text-align : center;
            border : 1px solid black;

        }
        table {
            border: 1px solid black;
            border-collapse:collapse;
        }
        body{
            overflow:none;
        }
        #tap {
            margin-left : 75px;
        }
        #export {
            margin-left:50px;
        }

        #loader {
            border: 16px solid #f3f3f3; /* Light grey */
            border-top: 16px solid #A8DAE5; /* Blue */
            border-radius: 50%;
            position:absolute;
            left:45%;
            top:35%;
            display:none;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
            z-index:5;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>
<div id="printing">
    <div id="loader"></div>
    Start Date : <input type="date" id ="start" required><br><br>

    <button onClick="submit()" id="tap">Submit</button><input type="button" id="export" value="excel" onClick="exportExcel()"><br><br>

    <table class="reporttable" style='border:1px solid black;border-collapse: collapse; text-align:center;'>
        <thead>  <tr style='border:1px solid black;background-color:#A8DAE5'><th style= 'text-align:center;border:1px solid black' colspan='3' >Date :</th><th id="sd" style= 'text-align:left;border:1px solid black;padding-left:50px' colspan='11' ></th></tr>
        <tr style='border:1px solid black;background-color:#A8DAE5'><th style= 'text-align:center;border:1px solid black' colspan='14' >Daily Report 2</th></tr>

        <tr style='background-color:#81969B;border:1px solid black'><th id = 'tablerows' colspan='1' >S.No.</th><th id = 'tablerows' colspan='1' >Date of Confirmation</th><th id = 'tablerows' colspan='1' >Name</th><th id = 'tablerows' colspan='1' >Age(in years)</th><th id = 'tablerows' colspan='1' >Sex (M/F)</th><th id = 'tablerows' colspan='1' >Door, Street Name</th><th id = 'tablerows' colspan='1' >Habitation</th><th id = 'tablerows' colspan='1' >Name of the block</th><th id = 'tablerows' colspan='1' >Name of the HUD</th><th id = 'tablerows' colspan='1' >Name of the District</th><th id = 'tablerows' colspan='1' >Contact Number</th><th id = 'tablerows' colspan='1' >Diagnosis Lab Confirmed</th><th id = 'tablerows' colspan='1' >Name of Hospital/organisation</th><th id = 'tablerows' colspan='1' >Remarks if any</th></tr>
        </thead>
    </table>
</div>
</body>
</html>